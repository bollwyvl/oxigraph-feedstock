{% set version = "0.3.9" %}
{% set native = "" %}  # [unix]
{% set native = "m2w64_" %}  # [win]

package:
  name: oxigraph
  version: {{ version }}

source:
  url: https://github.com/oxigraph/oxigraph/releases/download/v{{ version }}/oxigraph_v{{ version }}.tar.gz
  sha256: 4eb80814c7ae1a00fa9a8003050ef82b6b287dc717b290517f1621013960340d

build:
  number: 0

requirements:
  build:
    - {{ compiler(native ~ 'c') }}
    - {{ compiler(native ~ 'cxx') }}
    - {{ compiler('rust') }}

outputs:
  - name: oxigraph-server
    build:
      script:
        - bash {{ RECIPE_DIR }}/build-oxigraph.sh  # [unix]
        - call {{ RECIPE_DIR }}\bld-oxigraph-server.bat  # [win]
    requirements:
      build:
        - {{ compiler(native ~ 'c') }}
        - {{ compiler(native ~ 'cxx') }}
        - {{ compiler('rust') }}
        - cargo-bundle-licenses
      host:
        - clangdev  # [not osx]
        - openssl
    test:
      commands:
        - oxigraph_server --version
        - oxigraph_server --help

  - name: pyoxigraph
    build:
      script:
        - bash {{ RECIPE_DIR }}/build-oxigraph.sh  # [unix]
        - call {{ RECIPE_DIR }}\bld-pyoxigraph.bat  # [win]
    requirements:
      build:
        - {{ compiler(native ~ 'c') }}
        - {{ compiler(native ~ 'cxx') }}
        - {{ compiler('rust') }}
        - maturin >=0.14,<0.15
        - cargo-bundle-licenses
      host:
        - clangdev  # [not osx]
        - openssl
        - python
        - pip
        - mypy
        - black
      run:
        - python
    test:
      files:
        - test_licenses.py
      source_files:
        - python/tests
      imports:
        - pyoxigraph
      commands:
        - pip check
        - cd python/tests
        - pytest -vv --cov pyoxigraph --cov-report term-missing:skip-covered --cov-fail-under 100
      requires:
        - pip
        - pytest-cov
        - ruamel_yaml
        # fails pip check: https://github.com/conda-forge/importlib_metadata-feedstock/issues/88
        - importlib-metadata !=4.7.1

about:
  home: https://oxigraph.org
  summary: a SPARQL database and RDF toolkit
  license: Apache-2.0 OR MIT
  license_file:
    - LICENSE-APACHE
    - LICENSE-MIT
    - THIRDPARTY.yml

  dev_url: https://github.com/oxigraph/oxigraph
  doc_url: https://oxigraph.org

extra:
  feedstock-name: oxigraph
  recipe-maintainers:
    - bollwyvl
